version: 2.1

jobs:
  build_test:
    docker:
      - image: python:3.10

    steps:
      - checkout
      - run: echo "Building the project"
      - run:
          name: Install pipenv
          command: pip install pipenv
      - run:
          name: Activate virtual environnement
          command: /root/.local/bin/pipenv shell

      - run:
          name: Print environment variables
          command: printenv

      - run: echo "Building testing"
      - run:
          name: Run building test
          command: pytest

  containerize:
    docker:
      - image: docker:latest
    steps:
      - checkout
      - run: echo "Running containerize"
      - run: echo docker build -t oc_lettings .

  deploy:
    docker:
      - image: circleci/python:3.10
    steps:
      - checkout
      - run: echo "Running deploy"
      - run: docker push oc_lettings


workflows:
    build_test_deploy:
      jobs:
        - build_test
        - containerize:
            requires:
              - build_test
            filters:
              branches:
                only: main
        - deploy:
            requires:
              - containerize
            filters:
              branches:
                only: main